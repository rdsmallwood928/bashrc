# Here is the stuff you will want to modify if you are not @dougborg:
homeshickrepo="andsens/homeshick/"

homesickrepolist="dougborg/bashrc \
                  dougborg/vimrc"

bkupdirlist="${HOME}/.ssh \
             ${HOME}/.vim \
             ${HOME}/bin"

case ${PLATFORM} in
  darwin)
    function updateplatform {
      # Update all teh OSX things.
      sudo softwareupdate -i -a
      if which brew &> /dev/null; then
        brew update
        brew upgrade
        brew cleanup
      fi
      which npm &> /dev/null && npm update npm -g && npm update -g
      which gem &> /dev/null && sudo gem update
    }
    ;;
  linux)
    function updateplatform {
      # Update all teh Linux things.
      which apt-get &>/dev/null && sudo apt-get update && sudo apt-get upgrade
      which yum &> /dev/null && sudo yum update && sudo yum upgrade
      which npm &> /dev/null && npm update npm -g && npm update -g
      which gem &> /dev/null && sudo gem update
    }
    ;;
  *)
    function updateplatform {
      echo " I don't know how to update all teh things on this platform (${PLATFORM})."
    }
    ;;
esac

function bkup {
  # Make a copy of the path to *_bkup.
  local path=${1}
  local bkup=${path}_bkup

  if [[ -e "${path}" ]]; then
    cp -a "${path}" "${bkup}"
  fi
}

function restore {
  # Restores a _bkup dir/file.
  local bkup=${1}
  local new=${1%_bkup}

  if [[ -e "${bkup}" ]]; then
    [ ! -f ${new} ] && mkdir ${new}
    diff "${bkup}" "${new}"
    cp -ai "${bkup}" "${new}" && rm -rf "${bkup}"
  fi
}

function updatehome {
  # Use homeshick to keep my dotfiles up-to-date.
  local homesick=${HOME}/.homeshick

  # Initialize homesick if needed.
  if [[ ! -x ${homesick} ]]; then
    curl -sL https://raw.github.com/${homeshickrepo}/master/install.sh | bash
    for dir in ${bkupdirlist}; do bkup ${dir}; done
    for repo in ${homesickrepolist}; do ${homesick} clone ${repo}; done
  fi

  # Update homesick repos.
  ${homesick} pull && ${homesick} symlink
  source ${HOME}/.bashrc
  ( cd ${HOME}/.vim; make install )

  # Restore .ssh and bin, etc. if needed.
  for dir in ${bkupdirlist}; do restore ${dir}_bkup; done
}

function update {
  updateplatform
  updatehome
}

function ssh-init-home {
  local target=${1}

  ssh-copy-id ${target}
  ssh -At ${target} "$(declare -f bkup restore updatehome); updatehome; bash -l"
}

# vim: set ft=sh ts=2 sw=2 tw=0 :
